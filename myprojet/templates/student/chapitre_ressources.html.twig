{% extends 'student/dashCours.html.twig' %}

{% block title %}Ressources du chapitre{% endblock %}

{% block body %}
<div style="padding:25px; font-family:'Manrope', sans-serif; background:linear-gradient(140deg,#f8fbff,#eef2ff 55%,#f9fafb); min-height:100vh;">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px;">
    <div>
      <h2 style="margin:0; font-weight:800; font-size:1.6rem; color:#1f2937;">Ressources du chapitre</h2>
      <div style="margin-top:6px; color:#4b5563; font-size:0.92rem;">Cours: {{ cours ? cours.titre : '' }} | Chapitre: {{ chapitre.titre }}</div>
    </div>
    <a href="{{ path('eleve_cours_show', {'id': cours.id}) }}" style="text-decoration:none; padding:9px 14px; border-radius:999px; background:#e0e7ff; color:#3730a3; font-weight:700;">Retour au chapitre</a>
  </div>

  {% if top_ressources is defined and top_ressources is not empty %}
    <div style="background:#ffffff; border:1px solid #e2e8f0; border-radius:16px; padding:14px 16px; margin-bottom:16px;">
      <div style="font-weight:800; color:#111827; margin-bottom:8px;">Top 3 ressources</div>
      <ol style="margin:0; padding-left:20px; color:#374151;">
        {% for top in top_ressources %}
          <li style="margin-bottom:6px;">
            {{ top.titre }} ({{ top.badge }})
          </li>
        {% endfor %}
      </ol>
    </div>
  {% endif %}

  {% if ressources is not empty %}
    <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:18px;">
      {% for ressource in ressources %}
        {% set kind = ressource.categorie ? ressource.categorie.nom|lower : '' %}
        {% set isUrl = ressource.contenu starts with 'http://' or ressource.contenu starts with 'https://' %}
        {% set mediaSrc = isUrl ? ressource.contenu : asset(ressource.contenu) %}
        {% set isLiked = liked_ids is defined and ressource.id in liked_ids %}
        {% set isFavori = favori_ids is defined and ressource.id in favori_ids %}
        {% set isLocked = ressource.availableAt is not null and ressource.availableAt > date() %}
        {% set quizzes = quiz_by_ressource[ressource.id]|default([]) %}
        {% set quizResult = quiz_results[ressource.id]|default(null) %}

        <article id="ressource-{{ ressource.id }}" style="background:#fff; border-radius:20px; padding:18px; box-shadow:0 14px 28px rgba(20,24,40,0.08); border:1px solid #e7ecff;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:12px;">
            <h3 style="margin:0; color:#1f2937; font-size:1.05rem;">{{ ressource.titre }}</h3>
            <span style="font-size:0.72rem; font-weight:700; text-transform:uppercase; letter-spacing:.03em; background:#f3f4f6; color:#374151; padding:4px 8px; border-radius:999px;">{{ kind }}</span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; font-size:0.78rem;">
            <span style="background:#ecfdf5; color:#047857; border-radius:999px; padding:4px 9px;">{{ ressource.badge }}</span>
            <span style="background:#f8fafc; color:#334155; border-radius:999px; padding:4px 9px;">{{ ressource.nbVues }} vues</span>
            <span style="background:#fff1f2; color:#be123c; border-radius:999px; padding:4px 9px;">{{ ressource.nbLikes }} likes</span>
            {% if isLocked %}
              <span style="background:#fef3c7; color:#92400e; border-radius:999px; padding:4px 9px;">Disponible bientot</span>
            {% else %}
              <span style="background:#dcfce7; color:#166534; border-radius:999px; padding:4px 9px;">Disponible</span>
            {% endif %}
          </div>

          {% if isLocked %}
            <div style="padding:12px; border-radius:12px; background:#fffbeb; border:1px solid #fde68a; color:#92400e; font-weight:700;">
              Cette ressource sera disponible le {{ ressource.availableAt|date('d/m/Y a H:i') }}.
            </div>
          {% else %}
            {% if kind == 'video' %}
              <video controls preload="metadata" style="width:100%; border-radius:14px; background:#0f172a;">
                <source src="{{ mediaSrc }}">
                Votre navigateur ne supporte pas la lecture video.
              </video>
            {% elseif kind == 'audio' %}
              <audio controls preload="metadata" style="width:100%;">
                <source src="{{ mediaSrc }}">
                Votre navigateur ne supporte pas la lecture audio.
              </audio>
            {% elseif kind == 'image' %}
              <img src="{{ mediaSrc }}" alt="{{ ressource.titre }}" style="width:100%; border-radius:14px; object-fit:cover; max-height:260px;">
            {% elseif kind == 'pdf' %}
              <a href="{{ mediaSrc }}" target="_blank" rel="noopener" style="display:inline-block; padding:10px 14px; border-radius:10px; background:#fee2e2; color:#991b1b; font-weight:700; text-decoration:none;">Ouvrir le PDF</a>
            {% elseif kind == 'lien' %}
              <a href="{{ ressource.contenu }}" target="_blank" rel="noopener" style="display:inline-block; padding:10px 14px; border-radius:10px; background:#dcfce7; color:#166534; font-weight:700; text-decoration:none;">Ouvrir le lien</a>
              <div style="margin-top:8px; font-size:0.8rem; color:#6b7280; word-break:break-all;">{{ ressource.contenu }}</div>
            {% else %}
              <div style="color:#6b7280;">Ressource indisponible.</div>
            {% endif %}
          {% endif %}

          {% if quizzes is not empty %}
            <details style="margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid #dbe7ff; background:linear-gradient(180deg,#f8fbff,#f1f5ff);">
              <summary style="list-style:none; cursor:pointer; display:flex; align-items:center; gap:8px;">
                <span style="display:inline-block; border:1px solid #c7d2fe; padding:6px 12px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:0.86rem;">Faire le quiz</span>
                <span style="color:#64748b; font-size:0.8rem; font-weight:600;">Evaluation rapide</span>
              </summary>
              {% if isLocked %}
                <div style="margin-top:10px; font-size:0.85rem; color:#92400e;">
                  Le quiz sera disponible avec la ressource a partir du {{ ressource.availableAt|date('d/m/Y a H:i') }}.
                </div>
              {% else %}
                <form method="post" action="{{ path('eleve_ressource_quiz_submit', {'id': chapitre.id, 'ressourceId': ressource.id}) }}" style="margin-top:12px;">
                  <input type="hidden" name="_token" value="{{ csrf_token('quiz_submit_' ~ ressource.id) }}">
                  <input type="hidden" name="quiz_action" value="note">
                  <div style="margin-bottom:8px; color:#475569; font-size:0.82rem;">Reponds aux questions puis clique sur correction.</div>
                  <ol style="margin:0; padding-left:18px; color:#374151; font-size:0.9rem;">
                    {% for quiz in quizzes %}
                      {% set quizIndex = loop.index0 %}
                      <li style="margin-bottom:12px; padding-bottom:10px; border-bottom:1px dashed #dbeafe;">
                        <div style="font-weight:700; margin-bottom:6px;">
                          {{ quiz.question }}
                        </div>
                        {% if quiz.type == 'mcq' and quiz.choices is not empty %}
                          <div style="display:grid; gap:4px;">
                            {% for choice in quiz.choices %}
                              <label style="display:flex; gap:6px; align-items:flex-start; color:#4b5563;">
                                <input type="radio" name="quiz_answers[{{ quizIndex }}]" value="{{ choice }}">
                                <span>{{ choice }}</span>
                              </label>
                            {% endfor %}
                          </div>
                        {% else %}
                          <textarea
                            name="quiz_answers[{{ quizIndex }}]"
                            rows="2"
                            style="width:100%; border:1px solid #cbd5e1; border-radius:8px; padding:8px; font-size:0.9rem;"
                            placeholder="Ecris ta reponse ici"
                          ></textarea>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ol>
                  <button type="submit" style="border:none; padding:9px 14px; border-radius:10px; background:#16a34a; color:#fff; font-weight:800; margin-top:8px; box-shadow:0 6px 16px rgba(22,163,74,0.25);">Voir ma note</button>
                </form>

                {% if quizResult %}
                  <div style="margin-top:12px; border:1px solid #bbf7d0; background:#f0fdf4; color:#166534; border-radius:10px; padding:10px; font-weight:800;">
                    Note: {{ quizResult.note }}/20 ({{ quizResult.score }}/{{ quizResult.total }})
                  </div>
                  {% if not (quizResult.show_correction|default(false)) %}
                    <form method="post" action="{{ path('eleve_ressource_quiz_submit', {'id': chapitre.id, 'ressourceId': ressource.id}) }}" style="margin-top:10px;">
                      <input type="hidden" name="_token" value="{{ csrf_token('quiz_submit_' ~ ressource.id) }}">
                      <input type="hidden" name="quiz_action" value="correction">
                      <button type="submit" style="border:none; padding:8px 12px; border-radius:10px; background:#0ea5e9; color:#fff; font-weight:700;">Voir correction IA</button>
                    </form>
                  {% endif %}
                  {% if quizResult.show_correction|default(false) %}
                    <div style="margin-top:10px; display:grid; gap:8px;">
                      {% for correction in quizResult.corrections %}
                        <div style="border:1px solid #e5e7eb; border-radius:10px; padding:9px; background:#fff;">
                          <div style="font-weight:700; color:#1f2937;">{{ correction.question }}</div>
                          <div style="font-size:0.86rem; margin-top:5px; color:#475569;">Ta reponse: {{ correction.user_answer }}</div>
                          <div style="font-size:0.86rem; margin-top:3px; color:#0f766e;">Correction: {{ correction.expected_answer }}</div>
                          <div style="font-size:0.82rem; margin-top:5px; color:{{ correction.is_correct ? '#166534' : '#b91c1c' }};">
                            {{ correction.is_correct ? 'Correct' : 'Incorrect' }}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endif %}
              {% endif %}
            </details>
          {% endif %}

          {% if quizResult %}
            <div style="margin-top:10px; padding:8px 10px; border-radius:10px; border:1px solid #bbf7d0; background:#f0fdf4; color:#166534; font-size:0.85rem; font-weight:800;">
              Derniere note quiz: {{ quizResult.note }}/20
            </div>
          {% endif %}

          <div style="display:flex; gap:8px; margin-top:14px;">
            <form method="post" action="{{ path('app_ressource_like', {'id': ressource.id}) }}">
              <button
                {{ isLocked ? 'disabled' : '' }}
                style="border:none; padding:8px 12px; border-radius:10px; background:{{ isLiked ? '#fee2e2' : '#e2e8f0' }}; color:#1f2937; font-weight:700; cursor:{{ isLocked ? 'not-allowed' : 'pointer' }}; opacity:{{ isLocked ? '0.6' : '1' }};"
              >
                {{ isLiked ? 'Retirer Like' : 'Like' }}
              </button>
            </form>
            <form method="post" action="{{ path('app_ressource_favori', {'id': ressource.id}) }}">
              <button
                {{ isLocked ? 'disabled' : '' }}
                style="border:none; padding:8px 12px; border-radius:10px; background:{{ isFavori ? '#fde68a' : '#e2e8f0' }}; color:#1f2937; font-weight:700; cursor:{{ isLocked ? 'not-allowed' : 'pointer' }}; opacity:{{ isLocked ? '0.6' : '1' }};"
              >
                {{ isFavori ? 'Retirer Favori' : 'Favori' }}
              </button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div style="background:#fff; border-radius:16px; padding:20px; color:#6b7280; box-shadow:0 10px 24px rgba(20,24,40,0.06);">
      Aucune ressource n'est disponible pour ce chapitre.
    </div>
  {% endif %}
</div>
{% endblock %}
